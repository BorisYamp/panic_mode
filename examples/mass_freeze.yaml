/// Path: PanicMode/exampels/mass_freeze.yaml
# =============================================================================
# PanicMode: Mass Freeze Configuration
# =============================================================================
# 
# Этот файл определяет КАК выполнять массовую заморозку процессов.
# Редактируйте под вашу инфраструктуру!
#
# Документация: https://github.com/yourorg/panicmode/wiki/mass-freeze
# =============================================================================

# -----------------------------------------------------------------------------
# Режим работы массовой заморозки
# -----------------------------------------------------------------------------
# Определяет стратегию выбора процессов для заморозки.
#
# Доступные режимы:
#   all      - Заморозить ВСЁ кроме whitelist (экстренная "ядерная кнопка")
#   top_cpu  - Заморозить N самых прожорливых по CPU процессов
#   cluster  - Заморозить определённую группу связанных процессов
#
# По умолчанию: all
mode: all

# -----------------------------------------------------------------------------
# Настройки для режима: top_cpu
# -----------------------------------------------------------------------------
# Применяются только когда mode: top_cpu
top_cpu:
  # Количество процессов для заморозки (топ по CPU usage)
  # Процессы сортируются по CPU usage по убыванию, берутся первые N
  count: 5
  
  # Минимальный CPU usage для заморозки (опционально)
  # Процесс с CPU < min_cpu_percent не будет заморожен даже если в топе
  # min_cpu_percent: 10.0

# -----------------------------------------------------------------------------
# Настройки для режима: cluster
# -----------------------------------------------------------------------------
# Применяются только когда mode: cluster
cluster:
  # Метод определения кластеров:
  #
  #   manual - Вручную описываете группы процессов (РЕКОМЕНДУЕТСЯ)
  #            Работает везде, полный контроль
  #
  #   cgroup - Автоматически из systemd cgroups (только Linux с systemd)
  #            Автоматическое определение границ сервисов
  #
  # По умолчанию: manual
  detection: manual
  
  # ---------------------------------------------------------------------------
  # Для detection: manual
  # ---------------------------------------------------------------------------
  # Опишите логические группы (кластеры) процессов на вашем сервере.
  # Каждый кластер - это набор имён процессов.
  # Процесс попадает в кластер, если его имя СОДЕРЖИТ одно из указанных слов.
  #
  # Формат:
  #   cluster_name:
  #     - process_name_1
  #     - process_name_2
  #
  # Пример использования в monitor:
  #   actions:
  #     - mass_freeze_cluster:website
  definitions:
    # Кластер "website" - основной сайт компании
    # Типичный LAMP/LEMP stack
    website:
      - nginx           # Веб-сервер
      - php-fpm         # PHP обработчик
      - mysqld          # MySQL база данных
      - apache2         # Альтернатива nginx
    
    # Кластер "crm" - внутренняя CRM система
    # Современный Node.js + Redis + PostgreSQL stack
    crm:
      - node            # Node.js backend (будьте осторожны - может быть много!)
      - redis-server    # Кеш/очереди
      - postgres        # PostgreSQL база
    
    # Кластер "api" - микросервисная архитектура
    # Если у вас есть отдельный API layer
    api:
      - gunicorn        # Python WSGI сервер
      - celery          # Task queue workers
      - rabbitmq        # Message broker
    
    # Кластер "monitoring" - системы мониторинга
    # ВАЖНО: Обычно НЕ нужно замораживать, держите работающим!
    monitoring:
      - prometheus
      - grafana-server
      - node_exporter
      - alertmanager
    
    # Кластер "docker" - контейнеризованные приложения
    # Если запускаете сервисы в Docker
    docker:
      - dockerd
      - containerd
      - docker-proxy
    
    # -------------------------------------------------------------------------
    # Добавьте свои кластеры ниже
    # -------------------------------------------------------------------------
    # 
    # my_app:
    #   - my-service-name
    #   - my-worker-process
    #   - my-database
    # 
    # payment_system:
    #   - payment-gateway
    #   - stripe-webhook
    #   - transaction-processor
  
  # ---------------------------------------------------------------------------
  # Для detection: cgroup
  # ---------------------------------------------------------------------------
  # Маппинг понятных имён на systemd service names
  # Позволяет использовать короткие имена вместо полных service names
  #
  # Формат:
  #   alias_name: service_name.service
  #
  # Пример использования:
  #   actions:
  #     - mass_freeze_cluster:webserver  # вместо nginx.service
  service_aliases:
    webserver: nginx.service
    database: postgresql.service
    cache: redis.service
    webapp: my-app.service
    
    # Добавьте свои маппинги:
    # backend: my-backend.service
    # frontend: my-frontend.service

# -----------------------------------------------------------------------------
# Whitelist - процессы которые НИКОГДА не замораживаем
# -----------------------------------------------------------------------------
# Применяется для ВСЕХ режимов после основной фильтрации.
# Даже если процесс попал в топ CPU или в кластер - whitelist его спасёт.
#
# ВАЖНО: Помимо этого списка автоматически НЕ замораживаются (hardcoded):
#   - Все root процессы
#   - Процессы с "sshd" в имени (критично для удалённого доступа!)
#   - Собственный процесс PanicMode
#   - Родительские процессы до init/systemd
whitelist_processes:
  # ===== КРИТИЧНО: НЕ УДАЛЯЙТЕ! =====
  
  # SSH daemon - БЕЗ ЭТОГО ПОТЕРЯЕТЕ УДАЛЁННЫЙ ДОСТУП!
  - sshd
  
  # PanicMode сам себя (не замораживать!)
  - panicmode
  
  # ===== СИСТЕМНЫЕ СЕРВИСЫ =====
  
  # Мониторинг (чтобы видеть что происходит)
  - prometheus
  - node_exporter
  - grafana-server
  - collectd
  - telegraf
  
  # Логирование (чтобы не потерять логи инцидента)
  - rsyslogd
  - journald
  - fluentd
  - logstash
  
  # ===== КРИТИЧНЫЕ ДЛЯ БИЗНЕСА =====
  
  # Добавьте процессы, которые ВСЕГДА должны работать:
  # 
  # - payment-processor    # Платёжная система
  # - backup-daemon        # Бэкапы
  # - critical-api         # Критичный API
  
  # ===== ВАШ WHITELIST =====
  
  # Примеры (раскомментируйте и адаптируйте):
  # - nginx                # Если веб-сервер всегда должен работать
  # - postgres             # Если база всегда критична
  # - redis-server         # Если кеш критичен

# -----------------------------------------------------------------------------
# Расширенные настройки (опционально)
# -----------------------------------------------------------------------------

# Таймаут на операцию заморозки (защита от зависания)
# Если заморозка всех процессов занимает больше времени - прервать
# freeze_timeout: 30s

# Максимальное количество процессов для заморозки за раз
# Защита от случайной заморозки тысяч процессов
# max_processes_to_freeze: 1000

# Dry-run режим (только показать что будет заморожено, не замораживать)
# Полезно для тестирования конфигурации
# dry_run: false

# -----------------------------------------------------------------------------
# Примеры использования в config.yaml
# -----------------------------------------------------------------------------
#
# monitors:
#   # Пример 1: Тотальная заморозка при критической перегрузке
#   - name: "Total System Overload"
#     type: cpu_usage
#     threshold: 99
#     actions:
#       - mass_freeze              # Использует mode из mass_freeze.yaml
#       - snapshot
#       - alert_critical
#
#   # Пример 2: Точечная заморозка топ процессов
#   - name: "High CPU from Multiple Processes"
#     type: cpu_usage
#     threshold: 95
#     actions:
#       - mass_freeze_top          # Режим top_cpu
#       - alert_warning
#
#   # Пример 3: Заморозка конкретного кластера
#   - name: "Website CPU Spike"
#     type: cpu_usage
#     threshold: 90
#     actions:
#       - mass_freeze_cluster:website   # Только кластер website
#       - alert_warning
#
#   # Пример 4: Заморозка при подозрении на взлом
#   - name: "Suspicious Activity"
#     type: auth_failures
#     threshold: 50
#     actions:
#       - mass_freeze              # Заморозить всё
#       - snapshot                 # Снять snapshot для forensics
#       - alert_critical           # Немедленно оповестить

# -----------------------------------------------------------------------------
# Восстановление после заморозки
# -----------------------------------------------------------------------------
#
# ВАЖНО: НЕТ автоматической разморозки!
# Процессы остаются замороженными пока вы сами их не разморозите.
#
# Разморозка:
#   1. Подключитесь по SSH:
#      ssh admin@your-server
#
#   2. Разморозьте процессы:
#      # Разморозить всё:
#      sudo /usr/local/bin/panicmode-unfreeze
#
#      # Разморозить конкретный режим/кластер:
#      sudo /usr/local/bin/panicmode-unfreeze all
#      sudo /usr/local/bin/panicmode-unfreeze top_cpu
#      sudo /usr/local/bin/panicmode-unfreeze website
#
#   3. Проверьте состояние системы перед разморозкой!
#      top                # Текущая нагрузка
#      ps aux            # Список процессов
#      journalctl -xe    # Логи системы
#
# State файлы (информация о замороженных процессах):
#   /tmp/panicmode_frozen_all.state        # Для mode: all
#   /tmp/panicmode_frozen_top_cpu.state    # Для mode: top_cpu
#   /tmp/panicmode_frozen_website.state    # Для cluster: website

# -----------------------------------------------------------------------------
# Предупреждения
# -----------------------------------------------------------------------------
#
# ⚠️  ВНИМАНИЕ: Mass Freeze - это экстренная мера!
#
# Что произойдёт при заморозке:
#   - Веб-серверы перестанут отвечать на запросы
#   - Базы данных не будут обрабатывать транзакции
#   - Приложения "зависнут" для пользователей
#   - Системные сервисы (root) продолжат работу
#   - SSH доступ сохранится (критично!)
#
# Используйте только когда:
#   ✓ Критическая перегрузка системы (CPU 99%, Memory 99%)
#   ✓ Подозрение на взлом / вредоносный код
#   ✓ DDoS атака на уровне приложений
#   ✓ Runaway процесс жрёт все ресурсы
#   ✓ Другие меры не помогли
#
# НЕ используйте для:
#   ✗ Плановых работ (есть более мягкие способы)
#   ✗ Обычных нагрузок (настройте лучше автоскейлинг)
#   ✗ Тестирования (используйте dry_run: true)